/* シークログ風メモアプリ（IndexedDB） v2
   機能
   - 新規/編集/削除
   - タグタブ（上部）
   - アイコンと表示名をローカルに保存
   - テーマ画像をヘッダー背景に反映
   - JSON エクスポート / インポート
   - スマホ対応
*/

/* ----------------- ユーティリティと DB セットアップ ----------------- */
const DB_NAME = "seeklogDB";
const STORE = "notes";
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 2);
    req.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE)) {
        const store = db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
        store.createIndex("tags", "tags", { multiEntry: true });
        store.createIndex("pinned", "pinned");
        store.createIndex("updated", "updated");
      }
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(); };
    req.onerror = (e) => reject(e);
  });
}

function tx(mode = "readonly") {
  return db.transaction([STORE], mode).objectStore(STORE);
}

function getAllNotes() {
  return new Promise((resolve) => {
    const notes = [];
    const cursor = tx().openCursor();
    cursor.onsuccess = (e) => {
      const c = e.target.result;
      if (c) { notes.push(c.value); c.continue(); }
      else resolve(notes);
    };
  });
}

/* ----------------- ストレージ: プロフィール & テーマ ----------------- */
const PROFILE_KEY = "seeklog_profile";
const THEME_KEY = "seeklog_theme";

function saveProfile(obj) { localStorage.setItem(PROFILE_KEY, JSON.stringify(obj)); }
function loadProfile() { try { return JSON.parse(localStorage.getItem(PROFILE_KEY) || "null"); } catch { return null; } }
function saveTheme(base64) { if (base64) localStorage.setItem(THEME_KEY, base64); else localStorage.removeItem(THEME_KEY); }
function loadTheme() { return localStorage.getItem(THEME_KEY); }

/* ----------------- レンダリング ----------------- */
function el(id){ return document.getElementById(id); }

async function loadNotes(query = "", tagFilter = "") {
  let notes = await getAllNotes();
  if (query) {
    const q = query.toLowerCase();
    notes = notes.filter(n => (n.title||"").toLowerCase().includes(q) || (n.content||"").toLowerCase().includes(q));
  }
  if (tagFilter) {
    notes = notes.filter(n => (n.tags||[]).includes(tagFilter));
  }
  notes.sort((a,b) => {
    if ((b.pinned|0) !== (a.pinned|0)) return (b.pinned|0) - (a.pinned|0);
    return (b.updated||0) - (a.updated||0);
  });
  renderNotes(notes);
  renderTags(notes);
}

function renderNotes(notes) {
  const list = el("noteList");
  list.innerHTML = "";
  if (notes.length === 0) {
    list.innerHTML = "<div style='color:#6b7280'>メモがありません</div>";
    return;
  }
  notes.forEach(n => {
    const card = document.createElement("div");
    card.className = "note-card" + (n.pinned ? " pinned" : "");
    card.dataset.id = n.id;
    const title = document.createElement("div");
    title.innerHTML = `<strong>${escapeHtml(n.title||"(無題)")}</strong>`;
    const preview = document.createElement("div");
    preview.textContent = (n.content||"").slice(0,160);
    const tags = document.createElement("div");
    tags.className = "meta";
    tags.innerHTML = `<div>${(n.tags||[]).map(t=>`#${escapeHtml(t)}`).join(" ")}</div>
                      <div>${n.updated ? new Date(n.updated).toLocaleString() : ""}</div>`;
    card.appendChild(title);
    card.appendChild(preview);
    card.appendChild(tags);

    card.addEventListener("click", () => openEditor(n));
    list.appendChild(card);
  });
}

function renderTags(notes) {
  const set = new Set();
  notes.forEach(n => (n.tags||[]).forEach(t => set.add(t)));
  const tabs = el("tagTabs");
  tabs.innerHTML = "";

  const allBtn = document.createElement("button");
  allBtn.textContent = "すべて";
  allBtn.className = "active";
  allBtn.addEventListener("click", () => {
    document.querySelectorAll(".tag-tabs button").forEach(b=>b.classList.remove("active"));
    allBtn.classList.add("active");
    loadNotes(el("search").value, "");
  });
  tabs.appendChild(allBtn);

  [...set].sort().forEach(t => {
    const b = document.createElement("button");
    b.textContent = t;
    b.addEventListener("click", () => {
      document.querySelectorAll(".tag-tabs button").forEach(b2=>b2.classList.remove("active"));
      b.classList.add("active");
      loadNotes(el("search").value, t);
    });
    tabs.appendChild(b);
  });
  // 既存タグ一覧（サイド）も更新
  const sideTags = el("tagList");
  sideTags.innerHTML = "";
  [...set].sort().forEach(t => {
    const btn = document.createElement("button");
    btn.textContent = t;
    btn.addEventListener("click", () => {
      // タブを有効化
      Array.from(tabs.children).forEach(ch => ch.classList.toggle("active", ch.textContent===t));
      loadNotes(el("search").value, t);
    });
    sideTags.appendChild(btn);
  });
}

/* ----------------- エディタ操作 ----------------- */
let editingId = null;

function openEditor(note = null) {
  editingId = note ? note.id : null;
  el("editor").classList.remove("hidden");
  el("editor").setAttribute("aria-hidden","false");
  if (note) {
    el("noteTitle").value = note.title || "";
    el("noteContent").value = note.content || "";
    el("noteTags").value = (note.tags||[]).join(",");
    el("notePinned").checked = !!note.pinned;
  } else {
    el("noteTitle").value = "";
    el("noteContent").value = "";
    el("noteTags").value = "";
    el("notePinned").checked = false;
  }
  // スクロールしてエディタを見せる（スマホ用）
  setTimeout(()=>el("noteTitle").focus(), 120);
}

function closeEditor() {
  editingId = null;
  el("editor").classList.add("hidden");
  el("editor").setAttribute("aria-hidden","true");
}

/* ----------------- CRUD ----------------- */
function saveNote() {
  const title = el("noteTitle").value.trim();
  const content = el("noteContent").value.trim();
  const tags = el("noteTags").value.split(",").map(s=>s.trim()).filter(Boolean);
  const pinned = el("notePinned").checked ? 1 : 0;
  const updated = Date.now();

  const store = tx("readwrite");
  if (editingId) {
    const getReq = store.get(editingId);
    getReq.onsuccess = () => {
      const item = getReq.result || { id: editingId };
      item.title = title;
      item.content = content;
      item.tags = tags;
      item.pinned = pinned;
      item.updated = updated;
      store.put(item);
    };
  } else {
    const item = { title, content, tags, pinned, updated };
    store.add(item);
  }
  store.transaction.oncomplete = () => { closeEditor(); loadNotes(el("search").value); };
}

function deleteNote() {
  if (!editingId) return;
  if (!confirm("本当に削除しますか")) return;
  const store = tx("readwrite");
  store.delete(editingId);
  store.transaction.oncomplete = () => { closeEditor(); loadNotes(el("search").value); };
}

/* ----------------- プロフィール ----------------- */
function showProfileModal(show=true) {
  const modal = el("profileModal");
  if (show) modal.classList.remove("hidden");
  else modal.classList.add("hidden");
}

function renderProfile() {
  const p = loadProfile();
  const iconEl = el("profileIcon");
  const nameEl = el("profileName");
  if (p) {
    iconEl.src = p.icon || defaultIconData();
    nameEl.textContent = p.name || "名無し";
  } else {
    iconEl.src = defaultIconData();
    nameEl.textContent = "名無し";
  }
}

/* デフォルトアイコン（シンプルな SVG base64） */
function defaultIconData(){
  return "data:image/svg+xml;base64," + btoa(`<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#06b6d4'/><text x='50%' y='55%' font-size='36' text-anchor='middle' fill='white' font-family='sans-serif'>S</text></svg>`);
}

/* ----------------- テーマ反映 ----------------- */
function applyTheme() {
  const b64 = loadTheme();
  const header = el("appHeader");
  if (b64) {
    header.style.backgroundImage = `url(${b64})`;
  } else {
    header.style.backgroundImage = "";
  }
}

/* ----------------- エクスポート / インポート ----------------- */
function exportJSON() {
  getAllNotes().then(notes=>{
    const payload = { notes, profile: loadProfile(), theme: loadTheme() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `seeklog_export_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });
}
function importJSON(file) {
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const obj = JSON.parse(reader.result);
      if (obj.profile) saveProfile(obj.profile);
      if (obj.theme) saveTheme(obj.theme);
      if (Array.isArray(obj.notes)) {
        const store = tx("readwrite");
        obj.notes.forEach(n => {
          // keep id if exists otherwise add
          if (n.id) store.put(n); else store.add(n);
        });
        store.transaction.oncomplete = () => { renderProfile(); applyTheme(); loadNotes(); };
      } else {
        renderProfile(); applyTheme(); loadNotes();
      }
    } catch(e) { alert("インポートに失敗しました"); }
  };
  reader.readAsText(file);
}

/* ----------------- ヘルパー ----------------- */
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

/* ----------------- イベントバインド（DOMContentLoaded 内で行う） ----------------- */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    await openDB();
  } catch(e) {
    alert("IndexedDB を開けませんでした");
    console.error(e);
    return;
  }

  // 初期描画
  renderProfile();
  applyTheme();
  loadNotes();

  // UI 要素
  el("newBtn").addEventListener("click", ()=> openEditor(null));
  el("saveBtn").addEventListener("click", saveNote);
  el("cancelBtn").addEventListener("click", closeEditor);
  el("deleteBtn").addEventListener("click", deleteNote);
  el("search").addEventListener("input", (e)=> loadNotes(e.target.value));

  // プロフィールモーダル
  el("openProfileBtn").addEventListener("click", ()=> {
    const p = loadProfile();
    el("profileNameInput").value = p ? (p.name||"") : "";
    el("profileModal").classList.remove("hidden");
  });
  el("closeProfile").addEventListener("click", ()=> showProfileModal(false));
  el("saveProfile").addEventListener("click", ()=> {
    const name = el("profileNameInput").value.trim();
    const file = el("profileIconInput").files[0];
    if (file) {
      const fr = new FileReader();
      fr.onload = () => {
        saveProfile({ name, icon: fr.result });
        renderProfile();
        showProfileModal(false);
      };
      fr.readAsDataURL(file);
    } else {
      const p = loadProfile() || {};
      saveProfile({ name, icon: p.icon || defaultIconData() });
      renderProfile();
      showProfileModal(false);
    }
  });

  // クリックでプロフィール表示（小さな設定ショートカット）
  el("profileArea").addEventListener("click", ()=> el("openProfileBtn").click());

  // テーマ画像
  el("themeInput").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const fr = new FileReader();
    fr.onload = () => { saveTheme(fr.result); applyTheme(); };
    fr.readAsDataURL(f);
  });
  el("clearTheme").addEventListener("click", ()=> { saveTheme(null); applyTheme(); });

  // エクスポート/インポート
  el("exportBtn").addEventListener("click", exportJSON);
  el("importInput").addEventListener("change", (e)=> {
    const f = e.target.files[0];
    if (f) importJSON(f);
  });

  // プロフィール画像プレビュー時の初期化はモーダル開くときに行っている

  // キーボードショートカット（ESC でエディタ閉じる）
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (!el("editor").classList.contains("hidden")) closeEditor();
      if (!el("profileModal").classList.contains("hidden")) showProfileModal(false);
    }
  });

  // 簡単なデモデータ（初回のみ、コメントアウト可）
  // const demoExists = await getAllNotes().then(n=>n.length>0);
  // if (!demoExists) tx("readwrite").add({title:"使い方",content:"新規ボタンでメモ作成。タグでタブ切替可能。プロフィールで名前とアイコン設定。",tags:["チュートリアル"],pinned:0,updated:Date.now()});

});
